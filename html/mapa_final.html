
<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Mapa tras rowerowych â€” PÅ‚ock (final)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family:Arial,Helvetica,sans-serif; }
    #map { height: calc(100vh - 80px); }
    header { height:80px; padding:8px 12px; background:#f8f9fb; display:flex; align-items:center; gap:12px; }
    .controls { margin-left:auto; display:flex; gap:8px; align-items:center; }
    aside.controls-panel { position: absolute; left:10px; top:90px; z-index:1000; background:rgba(255,255,255,0.95); padding:10px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
    label { display:block; margin-bottom:6px; }
  </style>
</head>
<body>
  <header>
    <strong>Mapa tras rowerowych â€” PÅ‚ock</strong>
    <div class="controls">
      <label>Wczytaj GPX: <input id="gpxfile" type="file" accept=".gpx" /></label>
      <button id="toggleCyclo">PrzeÅ‚Ä…cz CyclOSM</button>
    </div>
  </header>

  <div id="map"></div>

  <div class="controls-panel" id="panel">
    <h4>Filtry</h4>
    <label><input type="checkbox" id="filter-family"/> Trasy rodzinne</label>
    <label><input type="checkbox" id="filter-sport"/> Trasy sportowe</label>
    <hr/>
    <label><input type="checkbox" id="show-pois" checked/> PokaÅ¼ miejsca odpoczynku</label>
    <label><input type="checkbox" id="show-stations" checked/> PokaÅ¼ stacje roweru miejskiego</label>
    <button id="apply-filters">Zastosuj filtry</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/dist/togeojson.js"></script>

  <script>
    const map = L.map('map').setView([52.546, 19.700], 12);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    const cyclo = L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', { attribution: '&copy; CyclOSM & OpenStreetMap contributors' });

    document.getElementById('toggleCyclo').onclick = () => {
      if (map.hasLayer(cyclo)) { map.removeLayer(cyclo); osm.addTo(map); }
      else { map.removeLayer(osm); cyclo.addTo(map); }
    };

    let trasyLayer = L.geoJSON(null, { style: styleTrasa, onEachFeature: onEachTrasa }).addTo(map);
    let poisLayer = L.geoJSON(null, { pointToLayer: (f,latlng)=>L.marker(latlng), onEachFeature: (f,l)=>{ if (f.properties && f.properties.name) l.bindPopup(f.properties.name); } }).addTo(map);
    let stationsLayer = L.geoJSON(null, { pointToLayer: (f,latlng)=>L.marker(latlng), onEachFeature: (f,l)=>{ if (f.properties && f.properties.name) l.bindPopup(f.properties.name); } }).addTo(map);

    function onEachTrasa(feature, layer) {
      let popup = '';
      if (feature && feature.properties) {
        if (feature.properties.name) popup += '<b>'+feature.properties.name+'</b><br/>';
        for (let k in feature.properties) { popup += '<i>'+k+':</i> '+feature.properties[k]+'<br/>'; }
      }
      if (popup) layer.bindPopup(popup);
    }

    fetch('trasy.geojson').then(r=>r.ok? r.json() : null).then(data=>{ if (data) trasyLayer.addData(data); });
    fetch('pois.geojson').then(r=>r.ok? r.json() : null).then(data=>{ if (data) poisLayer.addData(data); });
    fetch('stations_wgs84.geojson').then(r=>r.ok? r.json() : null).then(data=>{ if (data) stationsLayer.addData(data); });

function styleTrasa(feature) {
  const typ = (feature.properties?.typ || '').toLowerCase();

  if (typ.includes('ruch uspokojony')) {
    return { color: '#1a9850', weight: 4 }; // zielony â€” rodzinna
  }
  if (typ.includes('droga rowerowa')) {
    return { color: '#2b83ba', weight: 4 }; // niebieski â€” droga rowerowa
  }
  return { color: '#d73027', weight: 4 }; // czerwony â€” sportowa
}

function applyFilters() {
  const family = document.getElementById('filter-family').checked;
  const sport = document.getElementById('filter-sport').checked;

  trasyLayer.clearLayers();

  fetch('trasy.geojson').then(r => r.ok ? r.json() : null).then(data => {
    if (!data) return;

    const feats = data.features.filter(f => {
      const typ = (f.properties?.typ || '').toLowerCase();

      // jeÅ›li oba filtry wyÅ‚Ä…czone â†’ pokaÅ¼ wszystkie
      if (!family && !sport) return true;

      // rodzinna: tylko "ruch uspokojony"
      if (family && typ.includes('ruch uspokojony')) return true;

      // sportowa: wszystkie oprÃ³cz "ruch uspokojony" i "droga rowerowa"
      if (sport && !typ.includes('ruch uspokojony') && !typ.includes('droga rowerowa')) return true;

      return false;
    });

    trasyLayer.addData({ type: 'FeatureCollection', features: feats });
  });
}

// ðŸ”„ automatyczne filtrowanie przy zmianie checkboxÃ³w
['filter-family', 'filter-sport'].forEach(id => {
  document.getElementById(id).addEventListener('change', applyFilters);
});

// przy starcie
applyFilters();

// âœ… przywrÃ³cenie dziaÅ‚ania filtra stacji roweru miejskiego
document.getElementById('show-stations').addEventListener('change', function (e) {
  if (e.target.checked) map.addLayer(stationsLayer);
  else map.removeLayer(stationsLayer);
});


// ðŸ”„ automatyczne filtrowanie przy kaÅ¼dej zmianie checkboxa
['filter-family', 'filter-sport', 'filter-cycleways'].forEach(id => {
  document.getElementById(id).addEventListener('change', applyFilters);
});

// uruchom przy starcie
applyFilters();



    document.getElementById('apply-filters').onclick = applyFilters;

    document.getElementById('show-pois').addEventListener('change', function(e){ if (e.target.checked) poisLayer.addTo(map); else map.removeLayer(poisLayer); });
    document.getElementById('show-stations').addEventListener('change', function(e){ if (e.target.checked) stationsLayer.addTo(map); else map.removeLayer(stationsLayer); });

    let gpxLayer = L.layerGroup().addTo(map);
    document.getElementById('gpxfile').addEventListener('change', function(evt){
      const f = evt.target.files[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const gpxText = e.target.result;
        const parser = new DOMParser();
        const xml = parser.parseFromString(gpxText, "application/xml");
        const geojson = toGeoJSON.gpx(xml);
        if (!geojson) return alert('Brak Å›ladu w pliku GPX');
        gpxLayer.clearLayers();
        L.geoJSON(geojson, { style: { color:'#ff3333', weight:4 }, pointToLayer: (f,latlng)=>L.circleMarker(latlng,{radius:4}) }).addTo(gpxLayer);
        try { map.fitBounds(gpxLayer.getBounds(), {padding:[20,20]}); } catch(e) {}
      };
      reader.readAsText(f);
    });
  </script>
</body>
</html>
